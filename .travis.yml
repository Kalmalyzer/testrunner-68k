
__common: &common_build
  # language: rust
  # rust: stable
  # cache: cargo
  language: cpp

stages:
  - build
  - deploy

matrix:

  include:
#   - <<: *common_build
#     os: linux
#     dist: xenial

#     name: Linux build
#     stage: build

#     before_install:
#     # Build Tundra from source & install
#     - git clone --recursive https://github.com/deplinenoise/tundra.git
#     - cd tundra
#     - make
#     - sudo make install
#     - cd ..

#     script:

#     # Build Musashi
#     - tundra2

#     # Run testrunner-68k tests
# #    - cargo test

#   - <<: *common_build
#     os: windows

#     name: Windows build
#     stage: build

#     before_install:
#     # Fetch Tundra installer
#     - cmd.exe /C 'start /wait wget https://github.com/deplinenoise/tundra/releases/download/v2.09/Tundra-Setup.exe'
#     # Run Tundra installer
#     - cmd.exe /C 'start /wait Tundra-Setup.exe /S'
#     # Add Tundra binary path to current install path (as the installer does not refresh the current shell's env vars)
#     - PATH="$PATH:/c/Program Files/Tundra 2.0/bin"

#     script:

#     # Setup VC environment variables. We assume that VS 2017 is already installed on the machine.
#     # Then, build Musashi
#     - cmd.exe /C '"C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" amd64 && tundra2'

#     # Run testrunner-68k tests
# #    - cargo test

  - language: shell
    os: linux
    dist: xenial

    name: Deploy
    stage: deploy

    if: tag =~ /^release-/

    script:
    - zip -r testrunner-68k-source.zip . -x testrunner-68k-source.zip "target/*" ".git/*" "t2-output/*" ".tundra2.*"

    deploy:
      provider: releases
      api_key:
        secure: "Fvc5rfm0jge+6Z57IWZduMlUFYbKE1J35xsdRfNmsNRN7sTLsNw21KUfc0hdfEBUNXtj2EWdOORo+JMuFiz+8LtTgEc5AHa+mwc9h8voD72ri5N1XcITT5ac4Mo4iC3lW5jKHT3xW47NiY6Yw0K387sDZj6ccBTvjin1Q73QvrKM/RjoHF+FWIL/FGp39CyPC105EO2WcSZDHKcP01viSVtoBItXerWsar7bThYkTvR15glyBQiqpupkpniN075DymQtBKEDW8xDolMdihQBJXDLVDobEqOeAZmRJ/hiNb1KguUCYlJje4JeDP8TKjqQH/sg8uwI7mrbeBKBt4QOOWN+XvMnOe4GsKGbS3AHY3QTzJXaZ877/ChJqx1cfBNcWNw7ppCKaZqlkn1m2OSN5NXy8Hm5nt7fFR9KnxayEUu8uVx0kTTNWe72I4NnNBvCOExPtFJL5SD03uhOtc/cdFYAOEmP6sq79LY+tf3UF7QB4PwBcZpEW6FR3i/RFzmF3djpmxlrJfIsXa9o9XTUFhetlZZq2ezxmUvh5Lx9W781BGcY6r+Re2pzR4RZ7cZWE4c7jFyCLoXlZ8o5BYtfb5VM6HF6/0IS0b6oRvExGr3IRjlpvFXNJxqaNxvkfivwsouJqLI0UwaRydqO2lShIz6EoP7c2MsM/t9TdYj0w+E="
      file:
        - testrunner-68k-source.zip

      on:
        tags: true
